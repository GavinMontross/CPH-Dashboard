<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPH IT Workroom</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        templeDark: '#101010',
                        templePanel: '#1a1a1a',
                        templeCard: '#262626',
                        templeCherry: '#9D2235',
                        templeCherryBright: '#C52844',
                        statusNew: '#FFD700',
                        statusActive: '#00ced1'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Roboto', 'Segoe UI', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .fade-in {
            animation: fadeIn 0.8s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body class="bg-templeDark text-gray-200 h-screen w-screen overflow-hidden flex">

    <div class="w-[35%] h-full bg-templePanel border-r-2 border-templeCherry flex flex-col p-6">
        <div class="mb-8 text-center bg-templeDark rounded-xl py-6 border border-gray-800 shadow-md">
            <div id="clock" class="text-7xl font-bold text-white tracking-wider">00:00</div>
            <div id="date" class="text-2xl text-templeCherryBright font-bold mt-2 uppercase tracking-widest">Loading...
            </div>
        </div>

        <div class="flex-grow flex flex-col min-h-0">
            <h1 class="text-3xl font-black text-white border-b-4 border-templeCherry pb-3 mb-6 uppercase italic">
                <span id="staff-view-title">Today's Staff</span>
            </h1>
            <div id="shift-list" class="flex-grow overflow-y-auto space-y-4 pr-2">
                <div class="text-gray-500 italic text-xl p-4">Loading schedule...</div>
            </div>
        </div>
    </div>

    <div class="w-[65%] h-full bg-templeDark p-8 flex flex-col">
        <h1 class="relative text-3xl font-black text-white border-b-4 border-gray-700 pb-3 mb-6 flex justify-between items-center uppercase italic">
            
            <div class="flex items-center gap-4 z-10">
                <span>Ticket Queue</span>
                <span id="page-indicator" class="text-lg text-gray-500 font-mono font-normal normal-case"></span>
            </div>

            <div id="group-count-badge" 
                 class="hidden absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-[60%] flex items-center gap-3 bg-templePanel border-2 border-templeCherry px-6 py-1.5 rounded-full shadow-lg shadow-black/50 transition-all duration-500 z-0">
                <span class="text-sm font-bold text-gray-400 not-italic tracking-widest">GROUP OPEN</span>
                <span id="group-count-val" class="text-3xl font-bold text-white not-italic font-mono leading-none drop-shadow-md">0</span>
            </div>

            <span class="z-10 text-sm font-bold text-templeDark bg-gray-400 px-3 py-1 rounded flex items-baseline leading-tight not-italic">
                <span class="mr-1.5">REFRESH IN:</span>
                <span id="refresh-timer" class="font-mono tabular-nums w-6 text-center">60</span>
                <span class="ml-0.5">S</span>
            </span>
        </h1>

        <div id="ticket-list" class="grid grid-cols-1 xl:grid-cols-2 gap-6 overflow-hidden pb-4 h-full content-start">
            <div class="col-span-full text-gray-500 italic text-xl">Loading tickets...</div>
        </div>
    </div>

    <script>
        // --- GLOBAL VARIABLES ---
        let allTicketsData = [];
        let currentTicketPage = 0;
        const TICKETS_PER_PAGE = 8;
        let ticketCycleInterval = null;

        let allShiftsData = { today: [], tomorrow: [] };
        let currentStaffView = 'today';
        let staffCycleInterval = null;

        let refreshCountdown = 60;
        let countdownInterval = null;

        // --- 1. CLOCK LOGIC ---
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const dateOptions = { weekday: 'long', month: 'short', day: 'numeric' };
            document.getElementById('date').innerText = now.toLocaleDateString('en-US', dateOptions);
        }

        // --- REFRESH TIMER UI ---
        function startRefreshTimer() {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                refreshCountdown--;
                const timerEl = document.getElementById('refresh-timer');
                if (timerEl) timerEl.innerText = refreshCountdown;
                if (refreshCountdown <= 0) {
                    refreshCountdown = 60;
                    fetchData();
                }
            }, 1000);
        }

        // --- 2. DATA FETCHING ---
        async function fetchData() {
            try {
                const timerEl = document.getElementById('refresh-timer');
                if (timerEl) timerEl.innerText = "60";

                const [shiftsRes, ticketsRes] = await Promise.all([
                    fetch('/api/shifts'),
                    fetch('/api/tickets')
                ]);

                if (!shiftsRes.ok || !ticketsRes.ok) throw new Error("API call failed");

                allShiftsData = await shiftsRes.json();
                const ticketData = await ticketsRes.json();

                // HANDLE NEW DATA STRUCTURE
                let tickets = [];
                let groupCount = 0;

                if (Array.isArray(ticketData)) {
                    tickets = ticketData;
                } else {
                    tickets = ticketData.tickets || [];
                    groupCount = ticketData.groupCount || 0;
                }

                // Update Group Count UI
                const badge = document.getElementById('group-count-badge');
                const val = document.getElementById('group-count-val');
                
                if (groupCount > 0) {
                    // Removing 'hidden' allows the 'flex' in the HTML class to take effect
                    badge.classList.remove('hidden');
                    val.innerText = groupCount;
                } else {
                    badge.classList.add('hidden');
                }

                const isFirstLoad = !staffCycleInterval;
                renderStaff(isFirstLoad);
                handleTicketData(tickets, isFirstLoad);

                if (isFirstLoad) startStaffCycle();

            } catch (error) {
                console.error("Error loading dashboard data:", error);
            }
        }

        // --- 3. STAFF RENDERING ---
        function renderStaff(animate = true) {
            const container = document.getElementById('shift-list');
            const title = document.getElementById('staff-view-title');
            const animationClass = animate ? 'fade-in' : '';

            const shifts = allShiftsData[currentStaffView];
            title.innerText = currentStaffView === 'today' ? "Today's Staff" : "Tomorrow's Staff";

            if (!shifts || shifts.length === 0) {
                container.innerHTML = `<div class="text-gray-500 italic text-xl p-4 ${animationClass}">No shifts scheduled.</div>`;
                return;
            }

            const groupedShifts = {};
            shifts.forEach(s => {
                if (!groupedShifts[s.name]) {
                    groupedShifts[s.name] = { name: s.name, times: [] };
                }
                groupedShifts[s.name].times.push(s.timeRange);
            });

            container.innerHTML = Object.values(groupedShifts).map(person => {
                const timeString = person.times.join('<br>');
                return `
                <div class="bg-templeCard p-5 rounded-md border-l-[10px] border-templeCherry shadow-md flex justify-between items-center group hover:bg-[#333] transition-colors ${animationClass}">
                    <div>
                        <h2 class="text-3xl font-bold text-white mb-1 group-hover:text-templeCherryBright transition-colors">${person.name}</h2>
                        <p class="text-xl text-gray-400 font-mono leading-snug">${timeString}</p>
                    </div>
                </div>
                `;
            }).join('');
        }

        function startStaffCycle() {
            staffCycleInterval = setInterval(() => {
                currentStaffView = (currentStaffView === 'today') ? 'tomorrow' : 'today';
                renderStaff(true);
            }, 10000);
        }

        // --- 4. TICKET LOGIC ---
        function handleTicketData(tickets, animate = false) {
            allTicketsData = tickets || [];

            const totalPages = Math.ceil(allTicketsData.length / TICKETS_PER_PAGE);
            if (currentTicketPage >= totalPages) {
                currentTicketPage = Math.max(0, totalPages - 1);
            }
            renderTicketPage(animate);
            if (!ticketCycleInterval) startTicketCycle();
        }

        function renderTicketPage(animate = true) {
            const container = document.getElementById('ticket-list');
            const indicator = document.getElementById('page-indicator');
            const animationClass = animate ? 'fade-in' : '';

            if (allTicketsData.length === 0) {
                container.innerHTML = `<div class="col-span-full text-gray-500 italic text-xl ${animationClass}">No active tickets found.</div>`;
                indicator.innerText = "";
                return;
            }

            const start = currentTicketPage * TICKETS_PER_PAGE;
            const end = start + TICKETS_PER_PAGE;
            const ticketsToShow = allTicketsData.slice(start, end);
            const totalPages = Math.ceil(allTicketsData.length / TICKETS_PER_PAGE);

            indicator.innerText = totalPages > 1 ? `(Page ${currentTicketPage + 1} of ${totalPages})` : "";

            const html = ticketsToShow.map(t => {
                const isNew = t.status === 'New';
                const statusColor = isNew ? 'text-statusNew border-statusNew' : 'text-statusActive border-statusActive';
                const badgeBg = isNew ? 'bg-yellow-900/30' : 'bg-teal-900/30';

                return `
                <div class="bg-templeCard p-5 rounded-md shadow-lg border-t-4 ${statusColor.split(' ')[1]} flex flex-col justify-between h-48 ${animationClass}">
                    <div class="overflow-hidden">
                        <div class="flex justify-between items-start mb-1">
                            <div class="flex flex-col">
                                <span class="text-sm font-mono text-gray-500">#${t.id}</span>
                                <span class="text-sm text-gray-400 truncate w-52" title="${t.requestor}">${t.requestor}</span>
                            </div>
                            <span class="text-sm font-bold text-white bg-templeCherry px-2 py-1 rounded">${t.assignedTo}</span>
                        </div>
                        <h2 class="text-2xl font-semibold text-gray-100 leading-snug line-clamp-2 mt-1">${t.title}</h2>
                    </div>
                    
                    <div class="mt-2 flex items-center shrink-0">
                        <span class="text-sm font-bold tracking-wider uppercase px-3 py-1 rounded ${badgeBg} ${statusColor.split(' ')[0]}">
                            ${t.status}
                        </span>
                    </div>
                </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function startTicketCycle() {
            ticketCycleInterval = setInterval(() => {
                const totalPages = Math.ceil(allTicketsData.length / TICKETS_PER_PAGE);
                if (totalPages > 1) {
                    currentTicketPage++;
                    if (currentTicketPage >= totalPages) currentTicketPage = 0;
                    renderTicketPage(true);
                }
            }, 10000);
        }

        // --- INITIALIZATION ---
        setInterval(updateClock, 1000);
        updateClock();
        fetchData();
        startRefreshTimer();
    </script>
</body>

</html>